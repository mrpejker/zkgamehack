{"version":3,"sources":["../../src/client/app-index.tsx"],"sourcesContent":["import '../build/polyfills/polyfill-module'\nimport ReactDOMClient from 'react-dom/client'\nimport React, { use } from 'react'\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport { createFromReadableStream } from 'react-server-dom-webpack/client'\n\nimport { HeadManagerContext } from '../shared/lib/head-manager-context.shared-runtime'\nimport { onRecoverableError } from './on-recoverable-error'\nimport { callServer } from './app-call-server'\nimport {\n  type AppRouterActionQueue,\n  createMutableActionQueue,\n} from '../shared/lib/router/action-queue'\nimport { isNextRouterError } from './components/is-next-router-error'\nimport { handleClientError } from './components/react-dev-overlay/internal/helpers/use-error-handler'\nimport AppRouter from './components/app-router'\nimport type { InitialRSCPayload } from '../server/app-render/types'\nimport { createInitialRouterState } from './components/router-reducer/create-initial-router-state'\nimport { MissingSlotContext } from '../shared/lib/app-router-context.shared-runtime'\n\n// Patch console.error to collect information about hydration errors\nconst origConsoleError = window.console.error\nwindow.console.error = (...args) => {\n  // See https://github.com/facebook/react/blob/d50323eb845c5fde0d720cae888bf35dedd05506/packages/react-reconciler/src/ReactFiberErrorLogger.js#L78\n  const error = process.env.NODE_ENV !== 'production' ? args[1] : args[0]\n  if (!isNextRouterError(error)) {\n    if (process.env.NODE_ENV !== 'production') {\n      const { storeHydrationErrorStateFromConsoleArgs } =\n        require('./components/react-dev-overlay/internal/helpers/hydration-error-info') as typeof import('./components/react-dev-overlay/internal/helpers/hydration-error-info')\n\n      storeHydrationErrorStateFromConsoleArgs(...args)\n      handleClientError(error)\n    }\n\n    origConsoleError.apply(window.console, args)\n  }\n}\n\n/// <reference types=\"react-dom/experimental\" />\n\nconst appElement: HTMLElement | Document | null = document\n\nconst encoder = new TextEncoder()\n\nlet initialServerDataBuffer: (string | Uint8Array)[] | undefined = undefined\nlet initialServerDataWriter: ReadableStreamDefaultController | undefined =\n  undefined\nlet initialServerDataLoaded = false\nlet initialServerDataFlushed = false\n\nlet initialFormStateData: null | any = null\n\nfunction nextServerDataCallback(\n  seg:\n    | [isBootStrap: 0]\n    | [isNotBootstrap: 1, responsePartial: string]\n    | [isFormState: 2, formState: any]\n    | [isBinary: 3, responseBase64Partial: string]\n): void {\n  if (seg[0] === 0) {\n    initialServerDataBuffer = []\n  } else if (seg[0] === 1) {\n    if (!initialServerDataBuffer)\n      throw new Error('Unexpected server data: missing bootstrap script.')\n\n    if (initialServerDataWriter) {\n      initialServerDataWriter.enqueue(encoder.encode(seg[1]))\n    } else {\n      initialServerDataBuffer.push(seg[1])\n    }\n  } else if (seg[0] === 2) {\n    initialFormStateData = seg[1]\n  } else if (seg[0] === 3) {\n    if (!initialServerDataBuffer)\n      throw new Error('Unexpected server data: missing bootstrap script.')\n\n    // Decode the base64 string back to binary data.\n    const binaryString = atob(seg[1])\n    const decodedChunk = new Uint8Array(binaryString.length)\n    for (var i = 0; i < binaryString.length; i++) {\n      decodedChunk[i] = binaryString.charCodeAt(i)\n    }\n\n    if (initialServerDataWriter) {\n      initialServerDataWriter.enqueue(decodedChunk)\n    } else {\n      initialServerDataBuffer.push(decodedChunk)\n    }\n  }\n}\n\nfunction isStreamErrorOrUnfinished(ctr: ReadableStreamDefaultController) {\n  // If `desiredSize` is null, it means the stream is closed or errored. If it is lower than 0, the stream is still unfinished.\n  return ctr.desiredSize === null || ctr.desiredSize < 0\n}\n\n// There might be race conditions between `nextServerDataRegisterWriter` and\n// `DOMContentLoaded`. The former will be called when React starts to hydrate\n// the root, the latter will be called when the DOM is fully loaded.\n// For streaming, the former is called first due to partial hydration.\n// For non-streaming, the latter can be called first.\n// Hence, we use two variables `initialServerDataLoaded` and\n// `initialServerDataFlushed` to make sure the writer will be closed and\n// `initialServerDataBuffer` will be cleared in the right time.\nfunction nextServerDataRegisterWriter(ctr: ReadableStreamDefaultController) {\n  if (initialServerDataBuffer) {\n    initialServerDataBuffer.forEach((val) => {\n      ctr.enqueue(typeof val === 'string' ? encoder.encode(val) : val)\n    })\n    if (initialServerDataLoaded && !initialServerDataFlushed) {\n      if (isStreamErrorOrUnfinished(ctr)) {\n        ctr.error(\n          new Error(\n            'The connection to the page was unexpectedly closed, possibly due to the stop button being clicked, loss of Wi-Fi, or an unstable internet connection.'\n          )\n        )\n      } else {\n        ctr.close()\n      }\n      initialServerDataFlushed = true\n      initialServerDataBuffer = undefined\n    }\n  }\n\n  initialServerDataWriter = ctr\n}\n\n// When `DOMContentLoaded`, we can close all pending writers to finish hydration.\nconst DOMContentLoaded = function () {\n  if (initialServerDataWriter && !initialServerDataFlushed) {\n    initialServerDataWriter.close()\n    initialServerDataFlushed = true\n    initialServerDataBuffer = undefined\n  }\n  initialServerDataLoaded = true\n}\n\n// It's possible that the DOM is already loaded.\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', DOMContentLoaded, false)\n} else {\n  // Delayed in marco task to ensure it's executed later than hydration\n  setTimeout(DOMContentLoaded)\n}\n\nconst nextServerDataLoadingGlobal = ((self as any).__next_f =\n  (self as any).__next_f || [])\nnextServerDataLoadingGlobal.forEach(nextServerDataCallback)\nnextServerDataLoadingGlobal.push = nextServerDataCallback\n\nconst readable = new ReadableStream({\n  start(controller) {\n    nextServerDataRegisterWriter(controller)\n  },\n})\n\nconst initialServerResponse = createFromReadableStream(readable, {\n  callServer,\n})\n\n// React overrides `.then` and doesn't return a new promise chain,\n// so we wrap the action queue in a promise to ensure that its value\n// is defined when the promise resolves.\n// https://github.com/facebook/react/blob/163365a07872337e04826c4f501565d43dbd2fd4/packages/react-client/src/ReactFlightClient.js#L189-L190\nconst pendingActionQueue: Promise<AppRouterActionQueue> = new Promise(\n  (resolve, reject) => {\n    initialServerResponse.then(\n      (initialRSCPayload: InitialRSCPayload) => {\n        resolve(\n          createMutableActionQueue(\n            createInitialRouterState({\n              buildId: initialRSCPayload.b,\n              initialFlightData: initialRSCPayload.f,\n              initialCanonicalUrlParts: initialRSCPayload.c,\n              initialParallelRoutes: new Map(),\n              location: window.location,\n              couldBeIntercepted: initialRSCPayload.i,\n              postponed: initialRSCPayload.s,\n            })\n          )\n        )\n      },\n      (err: Error) => reject(err)\n    )\n  }\n)\n\nfunction ServerRoot(): React.ReactNode {\n  const initialRSCPayload = use<InitialRSCPayload>(initialServerResponse)\n  const actionQueue = use<AppRouterActionQueue>(pendingActionQueue)\n\n  const router = (\n    <AppRouter\n      actionQueue={actionQueue}\n      globalErrorComponent={initialRSCPayload.G}\n      assetPrefix={initialRSCPayload.p}\n    />\n  )\n\n  if (process.env.NODE_ENV === 'development' && initialRSCPayload.m) {\n    // We provide missing slot information in a context provider only during development\n    // as we log some additional information about the missing slots in the console.\n    return (\n      <MissingSlotContext value={initialRSCPayload.m}>\n        {router}\n      </MissingSlotContext>\n    )\n  }\n\n  return router\n}\n\nconst StrictModeIfEnabled = process.env.__NEXT_STRICT_MODE_APP\n  ? React.StrictMode\n  : React.Fragment\n\nfunction Root({ children }: React.PropsWithChildren<{}>) {\n  if (process.env.__NEXT_TEST_MODE) {\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    React.useEffect(() => {\n      window.__NEXT_HYDRATED = true\n      window.__NEXT_HYDRATED_CB?.()\n    }, [])\n  }\n\n  return children\n}\n\nexport function hydrate() {\n  const reactEl = (\n    <StrictModeIfEnabled>\n      <HeadManagerContext.Provider value={{ appDir: true }}>\n        <Root>\n          <ServerRoot />\n        </Root>\n      </HeadManagerContext.Provider>\n    </StrictModeIfEnabled>\n  )\n\n  const rootLayoutMissingTags = window.__next_root_layout_missing_tags\n  const hasMissingTags = !!rootLayoutMissingTags?.length\n\n  const options = {\n    onRecoverableError,\n  } satisfies ReactDOMClient.RootOptions\n  const isError =\n    document.documentElement.id === '__next_error__' || hasMissingTags\n\n  if (isError) {\n    if (process.env.NODE_ENV !== 'production') {\n      const createDevOverlayElement =\n        require('./components/react-dev-overlay/client-entry').createDevOverlayElement\n      const errorTree = createDevOverlayElement(reactEl)\n      ReactDOMClient.createRoot(appElement as any, options).render(errorTree)\n    } else {\n      ReactDOMClient.createRoot(appElement as any, options).render(reactEl)\n    }\n  } else {\n    React.startTransition(() =>\n      (ReactDOMClient as any).hydrateRoot(appElement, reactEl, {\n        ...options,\n        formState: initialFormStateData,\n      })\n    )\n  }\n\n  // TODO-APP: Remove this logic when Float has GC built-in in development.\n  if (process.env.NODE_ENV !== 'production') {\n    const { linkGc } =\n      require('./app-link-gc') as typeof import('./app-link-gc')\n    linkGc()\n  }\n}\n"],"names":["hydrate","origConsoleError","window","console","error","args","process","env","NODE_ENV","isNextRouterError","storeHydrationErrorStateFromConsoleArgs","require","handleClientError","apply","appElement","document","encoder","TextEncoder","initialServerDataBuffer","undefined","initialServerDataWriter","initialServerDataLoaded","initialServerDataFlushed","initialFormStateData","nextServerDataCallback","seg","Error","enqueue","encode","push","binaryString","atob","decodedChunk","Uint8Array","length","i","charCodeAt","isStreamErrorOrUnfinished","ctr","desiredSize","nextServerDataRegisterWriter","forEach","val","close","DOMContentLoaded","readyState","addEventListener","setTimeout","nextServerDataLoadingGlobal","self","__next_f","readable","ReadableStream","start","controller","initialServerResponse","createFromReadableStream","callServer","pendingActionQueue","Promise","resolve","reject","then","initialRSCPayload","createMutableActionQueue","createInitialRouterState","buildId","b","initialFlightData","f","initialCanonicalUrlParts","c","initialParallelRoutes","Map","location","couldBeIntercepted","postponed","s","err","ServerRoot","use","actionQueue","router","AppRouter","globalErrorComponent","G","assetPrefix","p","m","MissingSlotContext","value","StrictModeIfEnabled","__NEXT_STRICT_MODE_APP","React","StrictMode","Fragment","Root","children","__NEXT_TEST_MODE","useEffect","__NEXT_HYDRATED","__NEXT_HYDRATED_CB","reactEl","HeadManagerContext","Provider","appDir","rootLayoutMissingTags","__next_root_layout_missing_tags","hasMissingTags","options","onRecoverableError","isError","documentElement","id","createDevOverlayElement","errorTree","ReactDOMClient","createRoot","render","startTransition","hydrateRoot","formState","linkGc"],"mappings":"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"}