'use strict';

var observable = require('@trpc/server/observable');
var unstableCoreDoNotImport = require('@trpc/server/unstable-core-do-not-import');
var TRPCClientError = require('../TRPCClientError.js');
var httpUtils = require('./internals/httpUtils.js');

function httpLinkFactory(factoryOpts) {
    return (opts)=>{
        const resolvedOpts = httpUtils.resolveHTTPLinkOptions(opts);
        return ()=>({ op  })=>observable.observable((observer)=>{
                    const { path , input , type  } = op;
                    const { promise , cancel  } = factoryOpts.requester({
                        ...resolvedOpts,
                        type,
                        path,
                        input,
                        headers () {
                            if (!opts.headers) {
                                return {};
                            }
                            if (typeof opts.headers === 'function') {
                                return opts.headers({
                                    op
                                });
                            }
                            return opts.headers;
                        }
                    });
                    let meta = undefined;
                    promise.then((res)=>{
                        meta = res.meta;
                        const transformed = unstableCoreDoNotImport.transformResult(res.json, resolvedOpts.transformer.output);
                        if (!transformed.ok) {
                            observer.error(TRPCClientError.TRPCClientError.from(transformed.error, {
                                meta
                            }));
                            return;
                        }
                        observer.next({
                            context: res.meta,
                            result: transformed.result
                        });
                        observer.complete();
                    }).catch((cause)=>{
                        observer.error(TRPCClientError.TRPCClientError.from(cause, {
                            meta
                        }));
                    });
                    return ()=>{
                        cancel();
                    };
                });
    };
}
/**
 * @link https://trpc.io/docs/v11/client/links/httpLink
 */ const httpLink = httpLinkFactory({
    requester: httpUtils.jsonHttpRequester
});

exports.httpLink = httpLink;
exports.httpLinkFactory = httpLinkFactory;
